name: Rust CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install HDF5
        run: sudo apt-get update && sudo apt-get install -y libhdf5-dev
      - name: Check disk space
        run: df -h
      - name: Generate test data
        run: cargo run --example gen_test_data && cargo run --example gen_zarr_data
      - name: Run tests
        env:
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: "-C codegen-units=1"
        run: cargo test --verbose -j 1 --release -- --skip cli_hardening_test


  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Install HDF5
        run: sudo apt-get update && sudo apt-get install -y libhdf5-dev
      - name: Run clippy
        run: cargo clippy -- -D warnings

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install HDF5
        run: sudo apt-get update && sudo apt-get install -y libhdf5-dev
      - name: Build Release
        run: cargo build --release
      - name: Generate test data
        run: cargo run --example gen_test_data && cargo run --example gen_zarr_data
      - name: Run Smoke Test Script
        run: ./target/release/linal run examples/smoke_test.lnl
      - name: Check data persistence
        run: ls -R data/
